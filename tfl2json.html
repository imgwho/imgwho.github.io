<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TFL æ–‡ä»¶å¤„ç†å™¨ (Webç‰ˆ)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        /* CSS æ ·å¼éƒ¨åˆ† */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f2f5;
            color: #333;
        }

        #app-container {
            width: 90%;
            max-width: 600px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 2rem 3rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        h1 {
            color: #1a1a1a;
            margin-top: 0;
            margin-bottom: 1.5rem;
            font-weight: 600;
        }

        #drop-zone {
            border: 3px dashed #d9d9d9;
            border-radius: 8px;
            padding: 50px 20px;
            cursor: pointer;
            transition: border-color 0.3s, background-color 0.3s;
        }

        #drop-zone.drag-over {
            border-color: #1890ff;
            background-color: #e6f7ff;
        }
        
        #drop-zone p {
            margin: 0;
            color: #666;
            font-size: 1.1rem;
        }

        #file-input {
            display: none;
        }

        #status {
            margin-top: 1.5rem;
            font-size: 0.9rem;
            color: #555;
            min-height: 20px;
        }
        
        #download-links-container {
            margin-top: 1rem;
            text-align: left;
        }

        .download-link {
            display: block;
            margin: 8px 0;
            padding: 10px 15px;
            background-color: #f0f8ff;
            border-radius: 5px;
            text-decoration: none;
            color: #0056b3;
            font-weight: 500;
            transition: background-color 0.3s;
        }
        
        .download-link:hover {
            background-color: #d9eaff;
        }
        
        .download-link::before {
            content: 'ğŸ“„ ';
        }

    </style>
</head>
<body>

    <div id="app-container">
        <h1>TFL æ–‡ä»¶å¤„ç†å™¨ (Webç‰ˆ)</h1>
        <div id="drop-zone">
            <p>å°†ä¸€ä¸ªæˆ–å¤šä¸ª .tfl æ–‡ä»¶æ‹–åˆ°è¿™é‡Œ<br>æˆ–ç‚¹å‡»æ­¤åŒºåŸŸé€‰æ‹©æ–‡ä»¶</p>
            <input type="file" id="file-input" accept=".tfl" multiple>
        </div>
        <div id="status">çŠ¶æ€ï¼šç­‰å¾…æ–‡ä»¶...</div>
        <div id="download-links-container"></div>
    </div>

    <script>
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const statusDiv = document.getElementById('status');
        const downloadLinksContainer = document.getElementById('download-links-container');

        // --- äº‹ä»¶ç›‘å¬ ---

        // ç‚¹å‡»æ‹–æ”¾åŒºè§¦å‘æ–‡ä»¶é€‰æ‹©æ¡†
        dropZone.addEventListener('click', () => fileInput.click());

        // æ–‡ä»¶é€‰æ‹©æ¡†é€‰æ‹©æ–‡ä»¶
        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        // æ‹–åŠ¨æ–‡ä»¶è¿›å…¥åŒºåŸŸ
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault(); // å¿…é¡»é˜»æ­¢é»˜è®¤äº‹ä»¶ï¼Œæ‰èƒ½è§¦å‘ drop
            dropZone.classList.add('drag-over');
        });

        // æ‹–åŠ¨æ–‡ä»¶ç¦»å¼€åŒºåŸŸ
        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
        });

        // åœ¨åŒºåŸŸå†…é‡Šæ”¾æ–‡ä»¶
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            handleFiles(e.dataTransfer.files);
        });

        // --- æ ¸å¿ƒå¤„ç†é€»è¾‘ ---

        function handleFiles(files) {
            if (files.length === 0) {
                updateStatus("æœªé€‰æ‹©ä»»ä½•æ–‡ä»¶ã€‚", "info");
                return;
            }
            // å¼€å§‹å¤„ç†å‰æ¸…ç©ºæ—§å†…å®¹
            downloadLinksContainer.innerHTML = '';
            updateStatus(`æ”¶åˆ° ${files.length} ä¸ªæ–‡ä»¶ï¼Œæ­£åœ¨å¤„ç†...`, "info");
            
            // ä½¿ç”¨ Promise.all æ¥ç­‰å¾…æ‰€æœ‰æ–‡ä»¶å¤„ç†å®Œæˆ
            const processingPromises = Array.from(files).map(processFile);
            
            Promise.all(processingPromises).then(() => {
                updateStatus(`æ‰€æœ‰ä»»åŠ¡å¤„ç†å®Œæ¯•ï¼`, "success");
            });
        }

        function processFile(file) {
            return new Promise((resolve) => {
                if (!file.name.toLowerCase().endsWith('.tfl')) {
                    console.warn(`è·³è¿‡é .tfl æ–‡ä»¶: ${file.name}`);
                    resolve(); // è·³è¿‡é .tfl æ–‡ä»¶
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(event) {
                    const fileData = event.target.result;

                    // ä½¿ç”¨ JSZip åŠ è½½æ–‡ä»¶æ•°æ®
                    JSZip.loadAsync(fileData)
                        .then(zip => {
                            const flowFile = zip.file('flow');
                            if (flowFile) {
                                return flowFile.async('string'); // ä»¥å­—ç¬¦ä¸²å½¢å¼è¯»å– 'flow' æ–‡ä»¶
                            } else {
                                throw new Error("'flow' æ–‡ä»¶æœªåœ¨å‹ç¼©åŒ…ä¸­æ‰¾åˆ°ã€‚");
                            }
                        })
                        .then(content => {
                            // æˆåŠŸæå–å†…å®¹ï¼Œåˆ›å»ºä¸‹è½½é“¾æ¥
                            createDownloadLink(content, file.name);
                            resolve();
                        })
                        .catch(error => {
                            // å¤„ç†å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                            const errorNode = document.createElement('div');
                            errorNode.textContent = `âŒ å¤„ç† ${file.name} å¤±è´¥: ${error.message}`;
                            errorNode.style.color = 'red';
                            downloadLinksContainer.appendChild(errorNode);
                            console.error(`å¤„ç† ${file.name} å¤±è´¥:`, error);
                            resolve();
                        });
                };
                
                reader.onerror = function() {
                    const errorNode = document.createElement('div');
                    errorNode.textContent = `âŒ è¯»å– ${file.name} æ–‡ä»¶å¤±è´¥ã€‚`;
                    errorNode.style.color = 'red';
                    downloadLinksContainer.appendChild(errorNode);
                    console.error(`è¯»å– ${file.name} å¤±è´¥`);
                    resolve();
                };

                reader.readAsArrayBuffer(file); // ä»¥ ArrayBuffer æ ¼å¼è¯»å–æ–‡ä»¶
            });
        }
        
        function createDownloadLink(content, originalFileName) {
            // ç”Ÿæˆæ–°æ–‡ä»¶å
            const baseName = originalFileName.replace(/\.tfl$/i, '');
            const jsonFileName = `${baseName}.json`;

            // åˆ›å»º Blob å¯¹è±¡
            const blob = new Blob([content], { type: 'application/json;charset=utf-8' });
            
            // åˆ›å»ºä¸€ä¸ªå¯ä¸‹è½½çš„é“¾æ¥
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = jsonFileName;
            a.textContent = `ä¸‹è½½ ${jsonFileName}`;
            a.className = 'download-link';
            
            // å°†é“¾æ¥æ·»åŠ åˆ°é¡µé¢ä¸­
            downloadLinksContainer.appendChild(a);
            
            // æç¤ºï¼šå¯ä»¥è€ƒè™‘åœ¨ä¸€æ®µæ—¶é—´åç”¨ URL.revokeObjectURL(url) æ¥é‡Šæ”¾å†…å­˜ï¼Œ
            // ä½†å¯¹äºè¿™ç§ç”¨æˆ·ä¼šç«‹å³ç‚¹å‡»çš„åœºæ™¯ï¼Œé€šå¸¸ä¸æ˜¯å¤§é—®é¢˜ã€‚
        }

        function updateStatus(message, type = 'info') {
            statusDiv.textContent = `çŠ¶æ€ï¼š${message}`;
            switch(type) {
                case 'error':
                    statusDiv.style.color = '#ff4d4f';
                    break;
                case 'success':
                    statusDiv.style.color = '#52c41a';
                    break;

                default:
                    statusDiv.style.color = '#555';
            }
        }
    </script>

</body>
</html>
